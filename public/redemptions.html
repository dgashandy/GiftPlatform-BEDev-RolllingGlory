<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Redemptions - Gift Platform</title>
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/"><i class="bi bi-gift me-2"></i>Gift Platform</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/gifts.html">Gifts</a></li>
                </ul>
                <div class="d-flex align-items-center d-none" id="userMenu">
                    <span class="text-light me-3"><i class="bi bi-coin me-1"></i><span id="userPoints">0</span>
                        Points</span>
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <span id="userName">User</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile.html"><i
                                        class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item active" href="/redemptions.html"><i
                                        class="bi bi-bag me-2"></i>My Redemptions</a></li>
                            <li id="editGiftsLink" class="d-none"><a class="dropdown-item" href="/admin/gifts.html"><i
                                        class="bi bi-pencil-square me-2"></i>Edit Gifts</a></li>
                            <li id="adminPanelLink" class="d-none"><a class="dropdown-item" href="/admin/index.html"><i
                                        class="bi bi-speedometer2 me-2"></i>Admin Panel</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                        class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-5">
        <div class="container">
            <h2 class="fw-bold mb-4"><i class="bi bi-bag me-2"></i>My Redemptions</h2>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="redemptionTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="cart-tab" data-bs-toggle="tab" data-bs-target="#cart"
                        type="button" role="tab">
                        <i class="bi bi-cart me-2"></i>Cart <span class="badge bg-primary ms-1" id="cartBadge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history"
                        type="button" role="tab">
                        <i class="bi bi-clock-history me-2"></i>Redemption History
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="redemptionTabsContent">
                <!-- Cart Tab -->
                <div class="tab-pane fade show active" id="cart" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 fw-bold">Cart Items</h5>
                                </div>
                                <div class="card-body p-0" id="cartItems">
                                    <div class="text-center py-5 text-muted">
                                        <i class="bi bi-cart display-4"></i>
                                        <p class="mt-3">Your cart is empty</p>
                                        <a href="/gifts.html" class="btn btn-primary">Browse Gifts</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0 fw-bold">Order Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Total Items</span>
                                        <span id="totalItems">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="fw-bold">Total Points</span>
                                        <span class="fw-bold text-primary" id="totalPoints">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3 text-muted">
                                        <small>Your Points Balance</small>
                                        <small id="userBalance">0</small>
                                    </div>
                                    <button class="btn btn-success w-100 py-3 mb-2" onclick="redeemSelected()"
                                        id="redeemSelectedBtn" disabled>
                                        <i class="bi bi-check2-square me-2"></i>Redeem Selected (<span
                                            id="selectedCount">0</span>)
                                    </button>
                                    <button class="btn btn-primary w-100 py-2" onclick="redeemAllCart()" id="redeemBtn"
                                        disabled>
                                        <i class="bi bi-bag-check me-2"></i>Redeem All
                                    </button>
                                    <button class="btn btn-outline-danger w-100 mt-2" onclick="clearCart()"
                                        id="clearBtn" disabled>
                                        <i class="bi bi-trash me-2"></i>Clear Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0" id="historyList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rate this Gift</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h6 id="ratingGiftName" class="mb-4"></h6>
                    <input type="hidden" id="ratingGiftId">
                    <input type="hidden" id="ratingRedemptionId">
                    <div class="star-rating mb-4">
                        <i class="bi bi-star fs-2" data-star="1" onclick="selectStar(1)"></i>
                        <i class="bi bi-star fs-2" data-star="2" onclick="selectStar(2)"></i>
                        <i class="bi bi-star fs-2" data-star="3" onclick="selectStar(3)"></i>
                        <i class="bi bi-star fs-2" data-star="4" onclick="selectStar(4)"></i>
                        <i class="bi bi-star fs-2" data-star="5" onclick="selectStar(5)"></i>
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control" id="ratingReview" placeholder="Write a review (optional)"
                            rows="3"></textarea>
                    </div>
                    <button class="btn btn-primary w-100" onclick="submitRating()">Submit Rating</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let ratingModal;
        let selectedStars = 0;
        let userPointBalance = 0;

        document.addEventListener('DOMContentLoaded', () => {
            if (!requireAuth()) return;
            checkAuth();
            ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
            loadCart();
            loadHistory();
            loadUserBalance();
        });

        async function loadUserBalance() {
            try {
                const response = await api.get('/users/me');
                const user = response.data || response;
                userPointBalance = user.pointBalance || 0;
                document.getElementById('userBalance').textContent = formatNumber(userPointBalance);
                document.getElementById('userPoints').textContent = formatNumber(userPointBalance);
                updateCartSummary();
            } catch (error) {
            }
        }

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const container = document.getElementById('cartItems');

            document.getElementById('cartBadge').textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-cart display-4"></i>
                        <p class="mt-3">Your cart is empty</p>
                        <a href="/gifts.html" class="btn btn-primary">Browse Gifts</a>
                    </div>
                `;
                document.getElementById('redeemBtn').disabled = true;
                document.getElementById('clearBtn').disabled = true;
                updateCartSummary();
                return;
            }

            document.getElementById('redeemBtn').disabled = false;
            document.getElementById('clearBtn').disabled = false;

            container.innerHTML = `
                <div class="px-3 py-2 border-bottom bg-light d-flex align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                        <label class="form-check-label fw-bold" for="selectAll">Select All</label>
                    </div>
                </div>
                <ul class="list-group list-group-flush">
                    ${cart.map((item, index) => `
                        <li class="list-group-item py-3">
                            <div class="d-flex align-items-center">
                                <div class="form-check me-3">
                                    <input class="form-check-input cart-item-checkbox" type="checkbox" data-index="${index}" onchange="updateSelectedCount()">
                                </div>
                                <img src="${item.gift.imageUrl || '/assets/image.jpg'}" alt="${item.gift.name}" 
                                    class="rounded me-3" style="width: 80px; height: 80px; object-fit: cover;" onerror="this.src='/assets/image.jpg'">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold">${item.gift.name}</h6>
                                    <div class="text-primary fw-bold">
                                        <i class="bi bi-coin me-1"></i>${formatNumber(item.gift.pointsRequired)} pts × ${item.quantity}
                                    </div>
                                    <small class="text-muted">Subtotal: ${formatNumber(item.gift.pointsRequired * item.quantity)} pts</small>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="quantity-selector me-3">
                                        <button onclick="updateCartQty(${index}, -1)">-</button>
                                        <input type="number" value="${item.quantity}" readonly style="width: 40px;">
                                        <button onclick="updateCartQty(${index}, 1)">+</button>
                                    </div>
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeFromCart(${index})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                    `).join('')}
                </ul>
            `;
            updateCartSummary();
        }

        function updateCartSummary() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPoints = cart.reduce((sum, item) => sum + (item.gift.pointsRequired * item.quantity), 0);

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalPoints').textContent = formatNumber(totalPoints);

            const redeemBtn = document.getElementById('redeemBtn');
            if (totalPoints > userPointBalance && cart.length > 0) {
                redeemBtn.disabled = true;
                redeemBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Insufficient Points';
            } else if (cart.length > 0) {
                redeemBtn.disabled = false;
                redeemBtn.innerHTML = '<i class="bi bi-bag-check me-2"></i>Redeem All';
            }
        }

        function updateCartQty(index, delta) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const newQty = cart[index].quantity + delta;
            if (newQty >= 1 && newQty <= (cart[index].gift.stock || 99)) {
                cart[index].quantity = newQty;
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
            }
        }

        function removeFromCart(index) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            showToast('Item removed from cart', 'info');
        }

        function clearCart() {
            if (!confirm('Are you sure you want to clear your cart?')) return;
            localStorage.removeItem('cart');
            loadCart();
            showToast('Cart cleared', 'info');
        }

        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;

            const redeemSelectedBtn = document.getElementById('redeemSelectedBtn');
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');

            if (count > 0 && cart.length > 0) {
                let selectedPoints = 0;
                checkboxes.forEach(cb => {
                    const index = parseInt(cb.dataset.index);
                    selectedPoints += cart[index].gift.pointsRequired * cart[index].quantity;
                });
                redeemSelectedBtn.disabled = selectedPoints > userPointBalance;
            } else {
                redeemSelectedBtn.disabled = true;
            }

            const allCheckboxes = document.querySelectorAll('.cart-item-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
            }
        }

        async function redeemSelected() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox:checked');
            if (checkboxes.length === 0) {
                showToast('Please select items to redeem', 'warning');
                return;
            }

            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

            const redeemSelectedBtn = document.getElementById('redeemSelectedBtn');
            redeemSelectedBtn.disabled = true;
            redeemSelectedBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            try {
                const items = selectedIndices.map(index => ({
                    giftId: cart[index].giftId,
                    quantity: cart[index].quantity
                }));

                await api.post('/gifts/redeem/multiple', { items });

                selectedIndices.sort((a, b) => b - a).forEach(index => {
                    cart.splice(index, 1);
                });
                localStorage.setItem('cart', JSON.stringify(cart));

                loadCart();
                loadHistory();
                loadUserBalance();

                showToast('Selected items redeemed successfully!', 'success');

                if (cart.length === 0) {
                    const historyTab = new bootstrap.Tab(document.getElementById('history-tab'));
                    historyTab.show();
                }

            } catch (error) {
                showToast(error.message || 'Failed to redeem selected items', 'danger');
            } finally {
                redeemSelectedBtn.disabled = false;
                redeemSelectedBtn.innerHTML = '<i class="bi bi-check2-square me-2"></i>Redeem Selected (<span id="selectedCount">0</span>)';
                updateSelectedCount();
            }
        }

        async function redeemAllCart() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length === 0) return;

            const redeemBtn = document.getElementById('redeemBtn');
            redeemBtn.disabled = true;
            redeemBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            try {
                const items = cart.map(item => ({
                    giftId: item.giftId,
                    quantity: item.quantity
                }));

                const response = await api.post('/gifts/redeem/multiple', { items });

                localStorage.removeItem('cart');
                loadCart();
                loadHistory();
                loadUserBalance();

                showToast('All items redeemed successfully!', 'success');

                const historyTab = new bootstrap.Tab(document.getElementById('history-tab'));
                historyTab.show();

            } catch (error) {
                showToast(error.message || 'Failed to redeem items', 'danger');
                redeemBtn.disabled = false;
                redeemBtn.innerHTML = '<i class="bi bi-bag-check me-2"></i>Redeem All';
            }
        }

        async function loadHistory() {
            const container = document.getElementById('historyList');
            try {
                const response = await api.get('/users/me/redemptions');
                const redemptions = response.data || [];

                if (redemptions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-clock-history display-4"></i>
                            <p class="mt-3">No redemption history yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <ul class="list-group list-group-flush">
                        ${redemptions.map(r => `
                            <li class="list-group-item py-3">
                                <div class="d-flex align-items-center">
                                    <img src="${r.giftImageUrl || '/assets/image.jpg'}" alt="${r.giftName}" 
                                        class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" onerror="this.src='/assets/image.jpg'">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">${r.giftName}</h6>
                                        <small class="text-muted">
                                            ${new Date(r.createdAt).toLocaleDateString()} · 
                                            Qty: ${r.quantity} · 
                                            ${formatNumber(r.pointsSpent)} pts
                                        </small>
                                    </div>
                                    <div>
                                        ${r.hasRating
                        ? `<span class="badge bg-success"><i class="bi bi-star-fill me-1"></i>${r.rating.stars}★</span>`
                        : `<button class="btn btn-outline-primary btn-sm" onclick="openRatingModal('${r.giftId}', '${r.id}', '${r.giftName.replace(/'/g, "\\'")}')">
                                                <i class="bi bi-star me-1"></i>Rate
                                            </button>`
                    }
                                    </div>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } catch (error) {
                container.innerHTML = '<div class="text-center py-5 text-danger">Failed to load history</div>';
            }
        }

        function openRatingModal(giftId, redemptionId, giftName) {
            document.getElementById('ratingGiftId').value = giftId;
            document.getElementById('ratingRedemptionId').value = redemptionId;
            document.getElementById('ratingGiftName').textContent = giftName;
            document.getElementById('ratingReview').value = '';
            selectedStars = 0;
            updateStarDisplay();
            ratingModal.show();
        }

        function selectStar(star) {
            selectedStars = star;
            updateStarDisplay();
        }

        function updateStarDisplay() {
            document.querySelectorAll('.star-rating i').forEach(s => {
                const starValue = parseInt(s.dataset.star);
                s.className = starValue <= selectedStars ? 'bi bi-star-fill fs-2 text-warning' : 'bi bi-star fs-2';
            });
        }

        async function submitRating() {
            if (selectedStars === 0) {
                showToast('Please select a rating', 'warning');
                return;
            }

            const giftId = document.getElementById('ratingGiftId').value;
            const redemptionId = document.getElementById('ratingRedemptionId').value;
            const review = document.getElementById('ratingReview').value;

            try {
                await api.post(`/gifts/${giftId}/rating`, {
                    redemptionId,
                    stars: selectedStars,
                    review: review || undefined
                });

                ratingModal.hide();
                showToast('Rating submitted successfully!', 'success');
                loadHistory();
            } catch (error) {
                showToast(error.message || 'Failed to submit rating', 'danger');
            }
        }
    </script>
</body>

</html>