<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Redemptions - Gift Platform</title>
    <link href="/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/libs/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="bi bi-gift me-2"></i>Gift Platform
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/gifts.html">Gifts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/redemptions.html">My Redemptions</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center d-none" id="userMenu">
                    <span class="text-light me-3">
                        <i class="bi bi-coin me-1"></i>
                        <span id="userPoints">0</span> Points
                    </span>
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span id="userName">User</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile.html"><i
                                        class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="/redemptions.html"><i class="bi bi-bag me-2"></i>My
                                    Redemptions</a></li>
                            <li id="adminLink" class="d-none"><a class="dropdown-item" href="/admin/gifts.html"><i
                                        class="bi bi-gear me-2"></i>Admin Panel</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                        class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="py-5">
        <div class="container">
            <h2 class="fw-bold mb-4"><i class="bi bi-bag-check me-2"></i>My Redemptions</h2>

            <div id="redemptionsList">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-star me-2"></i>Rate Your Gift</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img id="ratingGiftImage" src="" alt="" class="rounded mb-3" style="max-width: 150px;">
                        <h6 id="ratingGiftName" class="fw-bold"></h6>
                    </div>
                    <form id="ratingForm">
                        <input type="hidden" id="ratingRedemptionId">
                        <input type="hidden" id="ratingGiftId">
                        <div class="mb-4 text-center">
                            <label class="form-label">Your Rating</label>
                            <div class="star-rating fs-2" id="starRating">
                                <i class="bi bi-star" data-value="1"></i>
                                <i class="bi bi-star" data-value="2"></i>
                                <i class="bi bi-star" data-value="3"></i>
                                <i class="bi bi-star" data-value="4"></i>
                                <i class="bi bi-star" data-value="5"></i>
                            </div>
                            <input type="hidden" id="ratingStars" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Review (Optional)</label>
                            <textarea class="form-control" id="ratingReview" rows="3"
                                placeholder="Tell us about your experience..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Submit Rating</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let ratingModal;

        document.addEventListener('DOMContentLoaded', async () => {
            if (!requireAuth()) return;
            checkAuth();
            showAdminLinkIfNeeded();
            loadRedemptions();

            ratingModal = new bootstrap.Modal(document.getElementById('ratingModal'));
            setupStarRating();

            document.getElementById('ratingForm').addEventListener('submit', handleRatingSubmit);
        });

        function showAdminLinkIfNeeded() {
            const user = getUser();
            if (user && (user.role === 'admin' || user.role === 'support')) {
                document.getElementById('adminLink').classList.remove('d-none');
            }
        }

        async function loadRedemptions() {
            try {
                const response = await api.get('/users/me/redemptions');
                const container = document.getElementById('redemptionsList');

                if (response.data && response.data.length > 0) {
                    container.innerHTML = response.data.map(r => createRedemptionCard(r)).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-bag-x display-1 text-muted"></i>
                            <h4 class="mt-3 text-muted">No Redemptions Yet</h4>
                            <p class="text-muted">Start browsing gifts and redeem your points!</p>
                            <a href="/gifts.html" class="btn btn-primary mt-3">Browse Gifts</a>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading redemptions:', error);
                showToast('Failed to load redemptions', 'danger');
            }
        }

        function createRedemptionCard(redemption) {
            const date = new Date(redemption.createdAt).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });

            const ratingSection = redemption.hasRating
                ? `<span class="badge bg-success"><i class="bi bi-check me-1"></i>Rated ${redemption.rating.stars}★</span>`
                : `<button class="btn btn-sm btn-outline-warning" onclick="openRatingModal('${redemption.id}', '${redemption.giftId}', '${escapeHtml(redemption.giftName)}', '${redemption.giftImageUrl || ''}')">
                    <i class="bi bi-star me-1"></i>Rate
                  </button>`;

            return `
                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <img src="${redemption.giftImageUrl || 'https://via.placeholder.com/80x80?text=Gift'}" 
                                    alt="${redemption.giftName}" class="rounded" style="width: 80px; height: 80px; object-fit: cover;">
                            </div>
                            <div class="col">
                                <h6 class="fw-bold mb-1">${redemption.giftName}</h6>
                                <p class="text-muted mb-1 small">
                                    <i class="bi bi-calendar me-1"></i>${date}
                                    <span class="mx-2">•</span>
                                    Qty: ${redemption.quantity}
                                </p>
                                <span class="badge bg-${redemption.status === 'completed' ? 'success' : 'warning'}">${redemption.status}</span>
                            </div>
                            <div class="col-auto text-end">
                                <div class="fw-bold text-primary mb-2">
                                    <i class="bi bi-coin me-1"></i>${redemption.pointsSpent.toLocaleString()} pts
                                </div>
                                ${ratingSection}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function openRatingModal(redemptionId, giftId, giftName, giftImageUrl) {
            document.getElementById('ratingRedemptionId').value = redemptionId;
            document.getElementById('ratingGiftId').value = giftId;
            document.getElementById('ratingGiftName').textContent = giftName;
            document.getElementById('ratingGiftImage').src = giftImageUrl || 'https://via.placeholder.com/150x150?text=Gift';
            document.getElementById('ratingStars').value = 0;
            document.getElementById('ratingReview').value = '';
            resetStars();
            ratingModal.show();
        }

        function setupStarRating() {
            const container = document.getElementById('starRating');
            const stars = container.querySelectorAll('i');

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const value = parseInt(star.dataset.value);
                    document.getElementById('ratingStars').value = value;
                    updateStars(value);
                });

                star.addEventListener('mouseenter', () => {
                    updateStars(parseInt(star.dataset.value));
                });
            });

            container.addEventListener('mouseleave', () => {
                updateStars(parseInt(document.getElementById('ratingStars').value));
            });
        }

        function updateStars(value) {
            const stars = document.querySelectorAll('#starRating i');
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill', 'text-warning');
                } else {
                    star.classList.remove('bi-star-fill', 'text-warning');
                    star.classList.add('bi-star');
                }
            });
        }

        function resetStars() {
            updateStars(0);
        }

        async function handleRatingSubmit(event) {
            event.preventDefault();

            const stars = parseInt(document.getElementById('ratingStars').value);
            if (stars < 1 || stars > 5) {
                showToast('Please select a rating', 'warning');
                return;
            }

            const redemptionId = document.getElementById('ratingRedemptionId').value;
            const giftId = document.getElementById('ratingGiftId').value;
            const review = document.getElementById('ratingReview').value;

            const submitBtn = event.target.querySelector('button[type="submit"]');

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

                await api.post(`/gifts/${giftId}/rating`, {
                    stars,
                    review: review || undefined,
                    redemptionId
                });

                showToast('Thank you for your rating!', 'success');
                ratingModal.hide();
                loadRedemptions();

            } catch (error) {
                showToast(error.message || 'Failed to submit rating', 'danger');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Rating';
            }
        }
    </script>
</body>

</html>